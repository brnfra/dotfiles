#!/usr/bin/env bash
# Arquivo: makeFolderByDate
# Autor: Bruno Franco
# Ultima_modificacao: 02-03-2023
# Download: git@github.com:brnfra
# Licence:Este arquivo é de domínio público
# Garantia: O autor não se responsabiliza por eventuais danos
#           causados pelo uso deste script.
#   Tem o proposito de organizar os arquivos que tem nome padrão começando com
#   o template AAAAmmdd, sendo AAAA para digito do ano, mm para digitos do mes,
#   dd para digito do dia
#   cria pasta no padrão ./AAAA/mm e insere os arquivos
#   não se aplica a pastas ou nomes diferentes do padrão
files=$(find . -type f -name '[0-9]*' | sed 's|\.\/||gi')
today_year=$( date +%Y )
today_year=$(( today_year + 1 ))
saveIn=${1:-'.'}
#create and move to folders
printf "[INFO] Creating folders and moving files.\n"

foldering_by_date() {
    local Dir="$1"
    for File in $files
    do
	file_name=${File##*/}
	#file_path=${File%/*}
	yearAux=$(echo "$file_name" | sed -r 's/(.{3}.).*/\1/gi')
	monthAux=$(echo "$file_name" | sed -r 's/(.{5}.).*/\1/gi; s/.*(.{2})/\1/gi')
	monthAux=${monthAux##*0}
	if [ "$yearAux" -gt 1900 ]  && [ "$monthAux" -gt 0 ] && [ 13 -gt "$monthAux" ] && [ "$today_year" -gt "$yearAux" ]
	then
	    echo "test pass arguments = ${Dir}/${yearAux}/${monthAux}"
	    echo "test pass filename = $File"
	    if [ "$HOME" != "$Dir" ]; then
		mkdir -p  "${Dir}/${yearAux}/${monthAux}" 
		mv -i "$File" "${Dir}/${yearAux}/${monthAux}" 
	    fi
	else
	    printf  "[INFO] %s. Nothing to do. No valid pattern like YYYYmm.\n" "$File"
	fi
    done
}

foldering_by_date "$saveIn"
printf "[INFO] Done.\n"
#delete empty folders crated
printf "[INFO] Deleting empty folders...\n"
find . -type d -empty -delete # &> /dev/null
printf "[INFO] Done.\n"

