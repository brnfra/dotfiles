#!/usr/bin/bash env

# Arquivo: arquivar
# Autor: Bruno Franco
# Ultima_modificacao: 06-01-2023
# Download: git@github.com:brnfra
# Licence:Este arquivo é de domínio público
# Garantia: O autor não se responsabiliza por eventuais danos
#           causados pelo uso deste script.

#   Tem o proposito de organizar os arquivos que tem nome padrão começando com
#   o template AAAAmmdd, sendo AAAA para digito do ano, mm para digitos do mes, 
#   dd para digito do dia

#   cria pasta no padrão ./AAAA/mm e insere os arquivos 
#   não se aplica a pastas ou nomes diferentes do padrão

files=$(find . -type f -name '[0-9]*' | sed 's|\.\/||gi')
today_year=$(date +%Y)
today_year=$((today_year + 1))
#create and move to folders
echo "Creating folders and moving files..."
for File in $files
do
    file_name=${File##*/}
    #file_path=${File%/*}
    yearAux=$(echo "$file_name" | sed -r 's/(.{3}.).*/\1/gi')
    monthAux=$(echo "$file_name" | sed -r 's/(.{5}.).*/\1/gi; s/.*(.{2})/\1/gi')
    if [[ today_year -gt yearAux ]] && [[ yearAux -gt 1900 ]] && [[ ${monthAux##*0} -gt 0 ]] && [[ 13 -gt ${monthAux##*0} ]]
    then
	mkdir -p -v ./"$yearAux/$monthAux"
	mv -v -i "$File" --target-directory=./"$yearAux/$monthAux"
    else
	echo "$File. Nothing to do. Searching valid pattern AAAAmm."
    fi
done
echo "Done!."

#delete empty folders crated
echo "Deleting empty folders..."
find . -type d -empty -delete &> /dev/null
echo "Done!"

